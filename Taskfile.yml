version: '3'

tasks:
  go:build:
    desc: Build the manager binary
    cmds:
      - go build -o bin/manager cmd/main.go

  go:build:cli:
    desc: Build the koncli binary
    cmds:
      - |
        VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
        COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
        BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        go build -ldflags "-X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE}" -o bin/koncli ./cli

  go:build:examples:
    desc: Build SDK examples
    cmds:
      - go build -o bin/sdk-example sdk/go/examples/basic_usage.go

  go:test:
    desc: Run all unit tests with coverage
    cmds:
      - go test -v -race -coverprofile=coverage.out ./api/... ./cli/... ./controllers/... ./sdk/...
      - go tool cover -func=coverage.out
      - go tool cover -html=coverage.out -o coverage.html

  go:test:cli:
    desc: Run CLI unit tests
    cmds:
      - go test -v -race ./cli/...

  go:test:controllers:
    desc: Run controller unit tests
    cmds:
      - go test -v -race -coverprofile=controllers-coverage.out ./controllers/...
      - go tool cover -func=controllers-coverage.out

  go:test:sdk:
    desc: Run SDK unit tests
    cmds:
      - go test -v -race -coverprofile=sdk-coverage.out ./sdk/go/...
      - go tool cover -func=sdk-coverage.out

  go:test:nocache:
    desc: Run tests without cache
    cmds:
      - go test -v ./... -count=1

  go:bench:
    desc: Run benchmark tests
    cmds:
      - go test -bench=. -benchmem ./...

  go:fmt:
    desc: Format and vet Go code
    cmds:
      - go fmt ./...
      - go vet ./...

  go:manifests:
    desc: Generate CRD manifests
    cmds:
      - export PATH=$PATH:$(go env GOPATH)/bin && controller-gen crd rbac:roleName=manager-role webhook paths="./..." output:crd:artifacts:config=config/crd/bases

  go:generate:
    desc: Generate code containing DeepCopy methods
    cmds:
      - export PATH=$PATH:$(go env GOPATH)/bin && controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."

  docker:build:
    desc: Build Docker image
    cmds:
      - docker build -t konductor:latest .

  docker:build:cli:
    desc: Build CLI Docker image
    cmds:
      - docker build -f cli/Dockerfile -t koncli:latest .

  k8s:install:
    desc: Install CRDs into the cluster
    cmds:
      - task: go:manifests
      - kubectl apply -f config/crd/bases/

  k8s:uninstall:
    desc: Uninstall CRDs from the cluster
    cmds:
      - kubectl delete -f config/crd/bases/ --ignore-not-found=true

  k8s:apply-samples:
    desc: Apply sample resources
    cmds:
      - kubectl apply -f config/samples/

  run:local:
    desc: Run the operator locally
    cmds:
      - task: go:manifests
      - task: go:generate
      - task: go:fmt
      - go run ./cmd/main.go

  e2e:run:
    desc: Run complete e2e test suite
    cmds:
      - cd e2e && task run

  e2e:test:
    desc: Run e2e tests only (assumes cluster exists)
    cmds:
      - cd e2e && task test

  e2e:setup:
    desc: Setup e2e environment only
    cmds:
      - cd e2e && task setup

  e2e:cleanup:
    desc: Cleanup e2e environment
    cmds:
      - cd e2e && task cleanup

  tools:install:
    desc: Install required tools
    cmds:
      - go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
      - go install sigs.k8s.io/kustomize/kustomize/v3@latest
      - go install golang.org/x/tools/cmd/godoc@latest

  docs:generate:
    desc: Generate API documentation
    cmds:
      - mkdir -p docs/api
      - godoc -html github.com/LogicIQ/konductor/sdk/go/client > docs/api/client.html
      - godoc -html github.com/LogicIQ/konductor/sdk/go/semaphore > docs/api/semaphore.html
      - godoc -html github.com/LogicIQ/konductor/sdk/go/barrier > docs/api/barrier.html
      - godoc -html github.com/LogicIQ/konductor/sdk/go/lease > docs/api/lease.html
      - godoc -html github.com/LogicIQ/konductor/sdk/go/gate > docs/api/gate.html

  docs:serve:
    desc: Serve documentation locally
    cmds:
      - godoc -http=:6060

  dev:setup:
    desc: Setup development environment
    cmds:
      - task: tools:install
      - task: go:manifests
      - task: go:generate
      - task: go:fmt