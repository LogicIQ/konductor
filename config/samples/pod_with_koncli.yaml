apiVersion: batch/v1
kind: Job
metadata:
  name: worker-with-koncli
  namespace: production
spec:
  template:
    spec:
      serviceAccountName: konductor-user
      containers:
      - name: worker
        image: my-app:latest
        env:
        # Optional: Explicit namespace via downward API
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        # Optional: Pod name for holder identification
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        command:
        - /bin/sh
        - -c
        - |
          set -e
          
          # Set up cleanup function
          cleanup() {
            if [ "$PERMIT_ACQUIRED" = "true" ]; then
              echo "Cleaning up: releasing permit..."
              if ! koncli semaphore release api-quota; then
                echo "Warning: Failed to release semaphore permit" >&2
              fi
            fi
          }
          trap cleanup EXIT
          
          PERMIT_ACQUIRED=false
          
          echo "Acquiring semaphore permit..."
          if koncli semaphore acquire api-quota --wait --ttl=10m; then
            PERMIT_ACQUIRED=true
          else
            echo "Failed to acquire semaphore permit" >&2
            exit 1
          fi
          
          echo "Processing data..."
          if ! ./process-data.sh; then
            echo "Data processing failed" >&2
            exit 1
          fi
          
          echo "Signaling completion..."
          if ! koncli barrier arrive processing-complete; then
            echo "Failed to signal completion" >&2
            exit 1
          fi
          
          echo "Releasing permit..."
          if koncli semaphore release api-quota; then
            PERMIT_ACQUIRED=false
            echo "Successfully released permit"
          else
            echo "Failed to release permit" >&2
            exit 1
          fi
        volumeMounts:
        - name: koncli
          mountPath: /usr/local/bin/koncli
          subPath: koncli
      volumes:
      - name: koncli
        configMap:
          name: koncli-binary
          defaultMode: 0755
      restartPolicy: Never
---
# Alternative: InitContainer pattern with auto-detection
apiVersion: batch/v1
kind: Job
metadata:
  name: worker-with-initcontainer
  namespace: production
spec:
  template:
    spec:
      serviceAccountName: konductor-user
      initContainers:
      - name: wait-for-dependencies
        image: konductor/koncli:latest
        command:
        - /bin/sh
        - -c
        - |
          if ! koncli gate wait processing-gate --timeout=30m; then
            echo "Failed to wait for dependencies" >&2
            exit 1
          fi
          echo "Dependencies ready"
      - name: acquire-resources
        image: konductor/koncli:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          cleanup() {
            if [ "$PERMIT_ACQUIRED" = "true" ]; then
              echo "Cleaning up: releasing permit..."
              koncli semaphore release api-quota || echo "Warning: Failed to release permit" >&2
            fi
          }
          trap cleanup EXIT
          
          PERMIT_ACQUIRED=false
          if koncli semaphore acquire api-quota --wait --ttl=30m; then
            PERMIT_ACQUIRED=true
            echo "Resource acquired"
          else
            echo "Failed to acquire semaphore permit" >&2
            exit 1
          fi
      containers:
      - name: worker
        image: my-app:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e
          cleanup() {
            echo "Cleaning up: releasing permit..."
            if ! koncli semaphore release api-quota; then
              echo "Warning: Failed to release permit" >&2
            fi
          }
          trap cleanup EXIT
          
          if ! ./process-data.sh; then
            echo "Data processing failed" >&2
            exit 1
          fi
          echo "Processing completed successfully"
      restartPolicy: Never
---
# ServiceAccount with proper RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: konductor-user
  namespace: production
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: production
  name: konductor-user
rules:
- apiGroups: ["sync.konductor.io"]
  resources: ["semaphores", "barriers", "leases", "gates", "permits", "arrivals", "leaserequests"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
- apiGroups: ["sync.konductor.io"]
  resources: ["semaphores/status", "barriers/status", "leases/status", "gates/status", "permits/status"]
  verbs: ["get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: konductor-user
  namespace: production
subjects:
- kind: ServiceAccount
  name: konductor-user
  namespace: production
roleRef:
  kind: Role
  name: konductor-user
  apiGroup: rbac.authorization.k8s.io